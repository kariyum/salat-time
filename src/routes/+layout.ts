export const ssr = false;
const data = [{ "id": "356", "label": "Beja", "delegations": [{ "label": "Amdoun", "id": "515" }, { "label": "Beja", "id": "629" }, { "label": "Goubellat", "id": "519" }, { "label": "Mejez El Bab", "id": "520" }, { "label": "Nefza", "id": "514" }, { "label": "Teboursouk", "id": "518" }, { "label": "Testour", "id": "517" }, { "label": "Tibar", "id": "516" }] }, { "id": "349", "label": "Ben Arous", "delegations": [{ "label": "Ben Arous", "id": "622" }, { "label": "Boumhel Bassatine", "id": "453" }, { "label": "El Mourouj", "id": "447" }, { "label": "Ezzahra", "id": "450" }, { "label": "Fouchana", "id": "446" }, { "label": "Hammam Chatt", "id": "452" }, { "label": "Hammam Lif", "id": "451" }, { "label": "Medina Jedida", "id": "454" }, { "label": "Megrine", "id": "448" }, { "label": "Mohamedia", "id": "445" }, { "label": "Mornag", "id": "444" }, { "label": "Rades", "id": "449" }] }, { "id": "361", "label": "Bizerte", "delegations": [{ "label": "Al Khitmin", "id": "572" }, { "label": "Al Matlin ", "id": "569" }, { "label": "Aousja", "id": "571" }, { "label": "Bizerte", "id": "634" }, { "label": "El Alia", "id": "566" }, { "label": "Ghar El Melh", "id": "563" }, { "label": "Ghezala", "id": "560" }, { "label": "Joumine", "id": "558" }, { "label": "Mateur", "id": "559" }, { "label": "Menzel Bourguiba", "id": "562" }, { "label": "Menzel Jemil", "id": "561" }, { "label": "Ras Jebel", "id": "564" }, { "label": "Sejnane", "id": "557" }, { "label": "Tinja", "id": "565" }, { "label": "Utique", "id": "567" }, { "label": "Zarzouna", "id": "568" }, { "label": "Zouaouine", "id": "570" }] }, { "id": "347", "label": "Gabes", "delegations": [{ "label": "El Hamma", "id": "1024" }, { "label": "Gabes", "id": "620" }, { "label": "Ghannouch", "id": "1019" }, { "label": "Mareth", "id": "1020" }, { "label": "Matmata", "id": "1022" }, { "label": "Matmata Nouvelle", "id": "1023" }, { "label": "Menzel Habib", "id": "1021" }, { "label": "Metouia", "id": "1025" }] }, { "id": "365", "label": "Gafsa", "delegations": [{ "label": "Belkhir", "id": "612" }, { "label": "El Guettar", "id": "611" }, { "label": "El Ksar", "id": "608" }, { "label": "Gafsa", "id": "638" }, { "label": "Mdhilla", "id": "607" }, { "label": "Metlaoui", "id": "606" }, { "label": "Moulares", "id": "604" }, { "label": "Redyef", "id": "605" }, { "label": "Sened", "id": "609" }, { "label": "Sidi Aich", "id": "610" }] }, { "id": "354", "label": "Jendouba", "delegations": [{ "label": "Ain Drahem", "id": "498" }, { "label": "Balta Bou Aouane", "id": "503" }, { "label": "Bou Salem", "id": "499" }, { "label": "Fernana", "id": "502" }, { "label": "Ghardimaou", "id": "501" }, { "label": "Jendouba", "id": "627" }, { "label": "Oued Mliz", "id": "500" }, { "label": "Tabarka", "id": "497" }] }, { "id": "357", "label": "Kairouan", "delegations": [{ "label": "Bou Hajla", "id": "528" }, { "label": "Chebika", "id": "522" }, { "label": "Chrarda", "id": "529" }, { "label": "El Alaa ", "id": "524" }, { "label": "Haffouz", "id": "523" }, { "label": "Hajeb El Ayoun", "id": "526" }, { "label": "Kairouan", "id": "630" }, { "label": "Nasrallah", "id": "527" }, { "label": "Oueslatia", "id": "525" }, { "label": "Sebikha", "id": "521" }] }, { "id": "362", "label": "Kasserine", "delegations": [{ "label": "El Ayoun", "id": "579" }, { "label": "Feriana", "id": "577" }, { "label": "Foussana", "id": "578" }, { "label": "Hassi Ferid", "id": "582" }, { "label": "Hidra", "id": "574" }, { "label": "Jedliane", "id": "581" }, { "label": "Kasserine", "id": "635" }, { "label": "Majel Bel Abbes", "id": "580" }, { "label": "Sbiba", "id": "576" }, { "label": "Sbitla", "id": "575" }, { "label": "Tala", "id": "573" }] }, { "id": "358", "label": "Ariana", "delegations": [{ "label": "Ariana", "id": "631" }, { "label": "Attadhamon", "id": "534" }, { "label": "Kalaat El Andalous ", "id": "530" }, { "label": "Mnihla", "id": "533" }, { "label": "Raoued", "id": "531" }, { "label": "Sidi Thabet", "id": "535" }, { "label": "Soukra", "id": "532" }] }, { "id": "1012", "label": "Kebili", "delegations": [{ "label": "Douz", "id": "484" }, { "label": "El Faouar", "id": "485" }, { "label": "Kebili", "id": "482" }, { "label": "Matrouha", "id": "486" }, { "label": "Rjim Maatoug", "id": "487" }, { "label": "Souk El Ahad", "id": "483" }] }, { "id": "363", "label": "Le kef", "delegations": [{ "label": "Dahmani", "id": "590" }, { "label": "El Ksour", "id": "583" }, { "label": "Jerissa", "id": "585" }, { "label": "Kal\u00c3\u00a2a El Khasba", "id": "587" }, { "label": "Kalaat Sinane", "id": "588" }, { "label": "Le Kef", "id": "636" }, { "label": "Le Sers", "id": "584" }, { "label": "Nebeur", "id": "589" }, { "label": "Sakiet Sidi Youssef", "id": "591" }, { "label": "Tejerouine", "id": "586" }, { "label": "Tourief", "id": "1523" }] }, { "id": "345", "label": "Mahdia", "delegations": [{ "label": "Boumerdes", "id": "427" }, { "label": "Chebba", "id": "424" }, { "label": "Chorbane", "id": "429" }, { "label": "El Jem", "id": "619" }, { "label": "Hbira", "id": "430" }, { "label": "Ksour Essef", "id": "423" }, { "label": "Mahdia", "id": "618" }, { "label": "Malloulech", "id": "425" }, { "label": "Ouled Chamekh", "id": "431" }, { "label": "Rejiche", "id": "1084" }, { "label": "Sidi Alouane", "id": "426" }, { "label": "Souassi", "id": "428" }] }, { "id": "360", "label": "Manouba", "delegations": [{ "label": "Borj El Amri", "id": "552" }, { "label": "Douar Hicher", "id": "554" }, { "label": "El Battan", "id": "551" }, { "label": "Jedaida", "id": "550" }, { "label": "Manouba", "id": "633" }, { "label": "Mornaguia", "id": "555" }, { "label": "Oued Ellil", "id": "553" }, { "label": "Tebourba", "id": "556" }] }, { "id": "353", "label": "Medenine", "delegations": [{ "label": "Arram", "id": "495" }, { "label": "Ben Guerdene", "id": "488" }, { "label": "Beni Khedach", "id": "489" }, { "label": "Djerba Ajim", "id": "493" }, { "label": "Djerba El May", "id": "491" }, { "label": "Djerba Houmt Souk", "id": "494" }, { "label": "Djerba Midoun", "id": "492" }, { "label": "Medenine", "id": "626" }, { "label": "Sidi Makhlouf", "id": "496" }, { "label": "Zarzis", "id": "490" }] }, { "id": "364", "label": "Monastir", "delegations": [{ "label": "Bekalta", "id": "601" }, { "label": "Benbla", "id": "603" }, { "label": "Beni Hassan", "id": "597" }, { "label": "Jammel", "id": "595" }, { "label": "Ksar Helal", "id": "602" }, { "label": "Ksibet Medyouni", "id": "599" }, { "label": "Moknine", "id": "598" }, { "label": "Monastir", "id": "637" }, { "label": "Ouerdanine", "id": "593" }, { "label": "Sahline", "id": "592" }, { "label": "Sayada Lamta Bouhjar", "id": "600" }, { "label": "Teboulba", "id": "594" }, { "label": "Zeramdine", "id": "596" }] }, { "id": "350", "label": "Nabeul", "delegations": [{ "label": "Beni Khalled", "id": "467" }, { "label": "Beni Khiar", "id": "460" }, { "label": "Bou Argoub", "id": "463" }, { "label": "Dar Chaabane Elfehri", "id": "468" }, { "label": "El Haouaria", "id": "466" }, { "label": "El Mida", "id": "457" }, { "label": "Grombalia", "id": "464" }, { "label": "Hammam Ghezaz", "id": "469" }, { "label": "Hammamet", "id": "461" }, { "label": "Kelibia", "id": "455" }, { "label": "Korba", "id": "459" }, { "label": "Menzel Bouzelfa", "id": "458" }, { "label": "Menzel Temime", "id": "456" }, { "label": "Nabeul", "id": "623" }, { "label": "Slimane", "id": "465" }, { "label": "Takelsa", "id": "462" }] }, { "id": "359", "label": "Sfax", "delegations": [{ "label": "Agareb", "id": "540" }, { "label": "Bir Ali Ben Khelifa", "id": "538" }, { "label": "El Amra", "id": "545" }, { "label": "El Hencha", "id": "541" }, { "label": "Ghraiba", "id": "539" }, { "label": "Jebiniana", "id": "536" }, { "label": "Kerkennah El Attaya", "id": "543" }, { "label": "Kerkennah Mellita", "id": "544" }, { "label": "Mahres", "id": "537" }, { "label": "Menzel Chaker", "id": "542" }, { "label": "Sakiet Eddaier", "id": "548" }, { "label": "Sakiet Ezzit", "id": "547" }, { "label": "Sfax", "id": "632" }, { "label": "Skhira", "id": "546" }, { "label": "Tina", "id": "549" }] }, { "id": "355", "label": "Sidi Bouzid", "delegations": [{ "label": "Bir El Hafey", "id": "508" }, { "label": "Hichria", "id": "1522" }, { "label": "Jelma", "id": "506" }, { "label": "Meknassi", "id": "505" }, { "label": "Menzel Bouzayane", "id": "510" }, { "label": "Mezouna", "id": "511" }, { "label": "Ouled Haffouz", "id": "512" }, { "label": "Regueb", "id": "504" }, { "label": "Sabbalet Ouled Asker", "id": "507" }, { "label": "Sidi Ali Ben Aoun", "id": "509" }, { "label": "Sidi Bouzid", "id": "628" }, { "label": "Souk Jedid", "id": "513" }] }, { "id": "344", "label": "Siliana", "delegations": [{ "label": "Bargou", "id": "417" }, { "label": "Bouarada", "id": "420" }, { "label": "El Aroussa", "id": "419" }, { "label": "Gaafour", "id": "418" }, { "label": "Kesra", "id": "414" }, { "label": "Le Krib", "id": "421" }, { "label": "Makther", "id": "415" }, { "label": "Rouhia", "id": "416" }, { "label": "Sidi Bou Rouis", "id": "422" }, { "label": "Siliana", "id": "617" }] }, { "id": "348", "label": "Sousse", "delegations": [{ "label": "Akouda", "id": "437" }, { "label": "Bouficha", "id": "433" }, { "label": "Enfida", "id": "434" }, { "label": "Hammam Sousse", "id": "438" }, { "label": "Hergla", "id": "435" }, { "label": "Kalaa Kebira", "id": "439" }, { "label": "Kalaa Seghira", "id": "443" }, { "label": "Koundar", "id": "442" }, { "label": "Msaken", "id": "440" }, { "label": "Sidi Bouali", "id": "436" }, { "label": "Sidi Elheni", "id": "441" }, { "label": "Sousse", "id": "621" }] }, { "id": "351", "label": "Tataouine", "delegations": [{ "label": "Bir Lahmar", "id": "474" }, { "label": "Bni Mhira", "id": "1524" }, { "label": "Borj El Khadra", "id": "475" }, { "label": "Dehiba", "id": "470" }, { "label": "El Borma", "id": "476" }, { "label": "Ghomrassen", "id": "473" }, { "label": "Remada", "id": "471" }, { "label": "Smar", "id": "472" }, { "label": "Tataouine", "id": "624" }] }, { "id": "352", "label": "Tozeur", "delegations": [{ "label": "Degueche", "id": "478" }, { "label": "Hammat Al Jarid", "id": "481" }, { "label": "Hazoua", "id": "479" }, { "label": "Nefta", "id": "477" }, { "label": "Tameghza", "id": "480" }, { "label": "Tozeur", "id": "625" }] }, { "id": "342", "label": "Tunis", "delegations": [{ "label": "Bab Bhar", "id": "404" }, { "label": "Bab Souika", "id": "395" }, { "label": "Bardo", "id": "394" }, { "label": "Carthage", "id": "387" }, { "label": "Cite El Khadhra", "id": "389" }, { "label": "El Hrairia", "id": "397" }, { "label": "El Kabaria", "id": "400" }, { "label": "El Menzah", "id": "390" }, { "label": "El Ouardia", "id": "399" }, { "label": "Ettahrir", "id": "393" }, { "label": "Ezzouhour", "id": "396" }, { "label": "Jebel Jelloud", "id": "401" }, { "label": "La Goulette", "id": "388" }, { "label": "La Marsa", "id": "386" }, { "label": "La Medina", "id": "403" }, { "label": "Le Kram", "id": "406" }, { "label": "Omrane", "id": "391" }, { "label": "Omrane Superieur", "id": "392" }, { "label": "Sidi El Bechir", "id": "402" }, { "label": "Sidi Hassine", "id": "398" }, { "label": "Sijoumi", "id": "405" }, { "label": "Tunis", "id": "615" }] }, { "id": "343", "label": "Zaghouan", "delegations": [{ "label": "Bir Mcherga", "id": "410" }, { "label": "El Fahs", "id": "411" }, { "label": "Nadhour", "id": "412" }, { "label": "Saouaf", "id": "413" }, { "label": "Zaghouan", "id": "616" }, { "label": "Zeriba", "id": "409" }] }]
function getUserPosition(): Promise<GeolocationPosition> {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            return reject(new Error('Geolocation is not supported by this browser.'));
        }
        navigator.geolocation.getCurrentPosition(
            resolve,
            (err) => {
                let msg = 'An unknown error occurred.';
                switch (err.code) {
                    case err.PERMISSION_DENIED:
                        msg = 'Location access was denied. Please enable it to see prayer times.';
                        break;
                    case err.POSITION_UNAVAILABLE:
                        msg = 'Location information is unavailable.';
                        break;
                    case err.TIMEOUT:
                        msg = 'The request to get user location timed out.';
                        break;
                }
                reject(new Error(msg));
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    });
}
export interface GeoData {
    city: string;
    countryName: string;
}

export interface PrayerTimings {
    Fajr: string;
    Sunrise: string;
    Dhuhr: string;
    Asr: string;
    Maghrib: string;
    Isha: string;
    [key: string]: string;
}

export interface PrayerData {
    timings: PrayerTimings;
    date: {
        readable: string;
        hijri: {
            day: string;
            weekday: { en: string };
            month: { en: string };
            year: string;
        };
    };
}
export interface PrayerDataAPI {
    code: number,
    status: string,
    data: [
        {
            timings: PrayerTimings,
            date: {
                readable: string
            }
        }
    ]
}


export interface PrayerDataMeteoAPI {
    sobh: string
    dhohr: string
    aser: string
    magreb: string
    isha: string
}
function getCityId(city: string): string | undefined {
    return data.find((value) => value.label.toLowerCase() == city)?.id;
}

function getDelegations(city: string) {
    return data.find((value) => value.label.toLowerCase() == city)?.delegations;
}

async function fetchPrayerApiData(latitude: number, longitude: number): Promise<PrayerDataAPI> {
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    const tuning = { imsak: 0, fajr: 0, sunrise: 0, dhuhr: 7, asr: -1, maghrib: +2, sunset: 0, isha: 0, midnight: 0 };
    const tuning_param = Object.entries(tuning).map(([key, value]) => value).join(",");
    const apiUrl = `https://api.aladhan.com/v1/calendar/${year}/${month}?latitude=${latitude}&longitude=${longitude}&method=18&tune=${tuning_param}`;
    const response = await fetch(apiUrl);
    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
    return response.json();
}

async function fetchPrayerTunisData(geoData: GeoData): Promise<PrayerDataAPI> {
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    const cityId = getCityId(geoData.city);
    const delegationId = getDelegations(geoData.city)?.at(0)?.id;
    const apiUrl = `https://www.meteo.tn/horaire_gouvernorat/${year}-${month}-${today}/${cityId}/${delegationId}`;
    const response = await fetch(apiUrl);
    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
    return response.json();
}

async function fetchGeoData(latitude: number, longitude: number): Promise<GeoData> {
    const geoApiUrl = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`;
    const response = await fetch(geoApiUrl);
    if (!response.ok) return { city: 'Unknown City', countryName: 'Unknown Country' };
    return response.json();
}


export const load = async () => {
    const position = getUserPosition();
    const prayerData = position.then((pos) => fetchPrayerApiData(pos.coords.latitude, pos.coords.longitude))
    const geoData = position.then((pos) => fetchGeoData(pos.coords.latitude, pos.coords.longitude))
    // if (!(prayerApiData.code === 200 && prayerApiData.data.length > 0)) {
    //     throw new Error('Could not retrieve prayer times for your location.');
    // }
    // const dayOfMonth = new Date().getDate();
    // prayerData = prayerApiData.data[dayOfMonth - 1];
    // locationName = `${geoData.city}, ${geoData.countryName}`;
    return {
        positionData: position,
        prayerData: prayerData,
        geoData: geoData
    }
}